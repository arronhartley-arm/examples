<html xmlns:fn="http://www.w3.org/2005/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Debugging Kernel Modules</title>
<link rel="stylesheet" href="../../common/docs/shared.css" type="text/css">
</head>
<body>
<div id="content_container">
    
    <a name="Debugging_Kernel_Modules"></a><h1>Debugging Kernel Modules - Arm®Development Studio</h1>
    <div class="toc"><div class="indent">
<b>Table of Contents:</b><ul>
<li><a href="#Purpose_and_scope">Purpose and scope</a></li>
<li><a href="#Installing_Linaro_GCC_arm-linux-gnueabihf_as_a_toolchain_in_Development_Studio">Installing Linaro GCC arm-linux-gnueabihf as a toolchain in Development Studio</a></li>
<li><a href="#Building_this_example">Building this example</a></li>
<li><a href="#Building_on_the_command-line">Building on the command-line</a></li>
<li><a href="#Building_with_Arm_Development_Studio">Building with Arm Development Studio</a></li>
<li><a href="#Building_the_example_against_your_own_kernel">Building the example against your own kernel</a></li>
<li><a href="#Running/debugging_this_example_on_the_Cortex-A9x1_FVP_model">Running/debugging this example on the Cortex-A9x1 FVP model</a></li>
<li><a href="#Using_the_kernel_module">Using the kernel module</a></li>
<li><a href="#Debugging_the_kernel_module">Debugging the kernel module</a></li>
<li><a href="#Debugging_a_user-space_application_and_kernel_module_together">Debugging a user-space application and kernel module together</a></li>
<li><a href="#Known_issues_and_troubleshooting">Known issues and troubleshooting</a></li>
</ul>
</div></div>
    
        <div class="para">A simple character device driver to illustrate the support for debug of Linux kernel modules.</div>
    <div class="note"><div class="para">
<span class="bold">Note</span><br>
                        For information on locating the example files and extracting them for use either on the command-line or in Arm Development Studio, see the <a href="../../install.html">installation instructions</a>.
                    </div></div>

    <div class="indent">
        <a name="Purpose_and_scope"></a><h2>Purpose and scope</h2>
        <div class="para">This example illustrates the support for debug of Linux kernel modules in the Debugger.  This kernel module example is a simple character device driver, that can be built against a Linux kernel on a Linux host workstation, and then run/debugged on a Linux target supported by Development Studio (either a real hardware target, or a model such as Cortex-A9x1 FVP model).</div>
        <div class="para">This example is intended to demonstrate features of the Debugger - it is not intended to be a tutorial on Linux kernel modules.</div>

        <div class="para">This example's files can be found in the <span class="arg">...\kernel_module</span> directory within <span class="arg">Linux_examples.zip</span>.  Import this .zip archive into your workspace to access the <span class="arg">kernel_module</span> project.</div>

        <div class="note"><div class="para">
<div class="bold">Note</div>This example is intended to be built with Linaro arm-linux-gnueabihf GCC.  If you wish to modify and rebuild the example, you must have Linaro arm-linux-gnueabihf GCC installed.  Linaro arm-linux-gnueabihf GCC is not supplied with Development Studio, but can be downloaded from the Linaro web-site (see below).</div></div>

        <div class="para">Pre-built executables are provided that can be used to run and debug the example.
        To rebuild this example, you must import into your workspace the "Linux Distribution Example" package that can be downloaded from the <a href="https://developer.arm.com/tools-and-software/embedded/legacy-tools/ds-5-development-studio/downloads" title="External link"><i>Downloads on developer.arm.com</i></a>.  
        This provides the example Linux <span class="arg">distribution</span> project/directory, and headers and libraries that are compatible with the example Linux distribution.</div>

        <h3>Terminology</h3>
        <div class="para">This document refers to 'host' and 'target' systems. The 'host' system is the Linux or Windows desktop computer that you use for most
        of your work. The 'target' system is some Arm-based hardware (or model of such hardware) on which the example Arm Linux distribution is running.</div>

        <h3>Hardware and software requirements</h3>
        <div class="para">A Linux host workstation is required to build this example, with a native GCC.
        The native GCC is required to build the kernel 'scripts' (actually C programs) that are part of the kernel build process.
        Pre-built images are provided for Windows users.</div>

        <h3>Requirements for target hardware</h3>
        <div class="para">This example can be run/debugged on a software model or real target hardware.  To run/debug it on your own real target hardware platform, the following will be needed:</div>
        <ul>
            <li><div class="para">Your platform and a suitable power supply for it.</div></li>
            <li><div class="para">Arm Linux installed on your platform, that you can boot and log-in to.</div></li>
            <li><div class="para">DSTREAM or ULINK debug hardware and a suitable power supply for it, and a JTAG cable to connect it to your platform.</div></li>
            <li><div class="para">A serial terminal emulator such as the Terminal view in Development Studio, PuTTY, TeraTerm, or Minicom for Linux, connected via a serial cable to your platform.
This may be needed when running the example on real target hardware, to monitor the Arm Linux boot process and provide a terminal interface to Arm Linux.  This is not needed if using a software model as that provides its own terminal.
To open the Terminal view in Development Studio, select <span class="menu">Window<span class="para"> → </span>Show View<span class="para"> → </span>Other...</span> to open the Show View dialog box, then expand the <span class="interface">Terminal</span> group and select <span class="interface">Terminal</span>, and click <span class="interface">OK</span>.
To configure the terminal settings, click on <span class="interface">Open a Terminal</span> in the <span class="interface">Terminal</span> view, then select the required connection type (for example, Serial Terminal), then enter the required settings (for example, 38400 baud, 8 bits, no parity, 1 stop bit) and click <span class="interface">OK</span>.
</div></li>
        </ul>

    </div>

    
    <div class="indent">
        <a name="Installing_Linaro_GCC_arm-linux-gnueabihf_as_a_toolchain_in_Development_Studio"></a><a name="about"></a><h2>Installing Linaro GCC arm-linux-gnueabihf as a toolchain in Development Studio</h2>
        <div class="para">To be able to modify and rebuild this example, download <a href="https://releases.linaro.org/archive/14.04/components/toolchain/binaries/" title="External link"><i>Linaro arm-linux-gnueabihf GCC 4.8 for Armv7/AArch32</i></a>, and untar it onto your host machine (making a note of the installation directory).  Then add it as a toolchain in Development Studio as follows:</div>
        
        <ol>
           <li><div class="para">In Development Studio, select <span class="menu">Window<span class="para"> → </span>Preferences<span class="para"> → </span>Arm DS<span class="para"> → </span>Toolchains</span>.</div></li>
           <li><div class="para">In the <span class="interface">Toolchains</span> dialog, click <span class="interface">Add</span>.</div></li>
           <li><div class="para">In the <span class="interface">Select Toolchain Path</span> dialog, enter the path to the toolchain binaries.  This is normally the <span class="arg">/bin</span> sub-directory of the installation directory noted above.  Then click <span class="interface">Next</span>.</div></li>
           <li><div class="para">In the <span class="interface">Discovered Toolchain Information</span> dialog, check the toolchain information is correct, then click <span class="interface">Finish</span>.</div></li>
           <li><div class="para">The new toolchain appears in the <span class="interface">Toolchains</span> dialog, click <span class="interface">Apply</span>, then click <span class="interface">Restart</span>.</div></li>
        </ol>

    </div>


    <div class="indent">
        <a name="Building_this_example"></a><h2>Building this example</h2>
        
        <div class="para">This example is intended to be built with a GCC cross-compiler for Arm Linux target, such as the Linaro GCC toolchain, that must be downloaded, installed, and added as a toolchain as described earlier.</div>

        <div class="para">This example can be rebuilt on Linux platforms using the <span class="arg">Makefile</span> supplied, either with the <span class="arg">kernel_module</span> Eclipse
        (makefile builder) project supplied, or directly on the command-line with the <span class="arg">make</span> utility.
        Pre-built images are provided for Windows users.</div>
        <div class="para">To rebuild this example, you must have imported into your workspace the "Linux Distribution Example" package that can be downloaded from the <a href="https://developer.arm.com/tools-and-software/embedded/legacy-tools/ds-5-development-studio/downloads" title="External link"><i>Downloads on developer.arm.com</i></a>.  This provides the example Linux <span class="arg">distribution</span> project/directory needed to build the module against the Linux kernel.  The <span class="arg">distribution</span> project does not need to be built (actually, it cannot be built).</div>
        <div class="para">The <span class="arg">Makefile</span> supplied will first initialize the kernel trees (including rebuilding the kernel,
        which may take some time), then build the kernel module against the kernel, then strip away the unneeded symbols
        from the kernel module, and finally build a simple user-space main.c calling application too.</div>
        <div class="para">For a good debug view, the compiler's optimization level for building the user-space <span class="arg">main()</span> is set to -O0 in the
        <span class="arg">Makefile</span>.  You can change this to raise the optimization level to -O2 or -O3 for higher performance code generation,
        but at the cost of a worse debug view.</div>
        <div class="para">Alternatively, to debug this example, use the pre-built executables provided instead of re-building them.
Pre-built executables for the FVP models are provided. It is still necessary to import the "Linux Distribution Example" package as this provides the debug symbols required for kernel-aware debug.
The pre-built kernel module <span class="arg">/FVP_VE_V7/modex.ko</span> was built against the FVP_VE_V7 example kernel, so is intended to be run on the FVP_VE_V7 example kernel on the Cortex-A9x1 FVP model.</div>
        <div class="para">Building the example produces both stripped and unstripped versions of the ELF kernel module <span class="arg">modex.ko</span> and user-space <span class="arg">main</span> application.
        The unstripped (debug) versions contains debug information for loading into the Debugger on the host.
        The smaller stripped (no debug) versions for downloading to the target are created by stripping off the unneeded debug information.</div>
    </div>

    <div class="indent">
        <a name="Building_on_the_command-line"></a><h2>Building on the command-line</h2>
        <div class="para">To build on the Linux host command-line with the supplied <span class="arg">make</span> utility,
        navigate to <span class="arg">.../kernel_module</span>, then type:</div>
        <div class="para"><span class="arg">make</span></div>
        <div class="para">The usual <span class="arg">make</span> rules: <span class="arg">all</span> and <span class="arg">clean</span> are provided in the <span class="arg">Makefile</span>.</div>
    </div>

    <div class="indent">
        <a name="Building_with_Arm_Development_Studio"></a><h2>Building with Arm Development Studio</h2>

        
    <ol>
        <li><div class="para">In the Project Explorer view, select the project you want to build.</div></li>
        <li><div class="para">Select <span class="menu">Project<span class="para"> → </span>Build Project</span>.</div></li>
    </ol>


        <div class="para">The <span class="arg">kernel_module</span> Eclipse (makefile builder) project is used to build the kernel module <span class="arg">modex.ko</span> and user-space <span class="arg">main</span> application.</div>
    </div>

    <div class="indent">
        <a name="Building_the_example_against_your_own_kernel"></a><h2>Building the example against your own kernel</h2>
        <div class="para">The <span class="arg">Makefile</span> supplied builds the kernel module against the example Linux kernel supplied with Development Studio.  If you have your own
        (different) kernel, you can use <span class="arg">Makefile_generickernel</span> to build against your own kernel trees. This Makefile should be invoked as:</div>
        <pre class="code">make -f Makefile_generickernel KERNEL_SOURCE_DIR=<span class="repl">&lt;...&gt;</span></pre>
        <div class="para">where <span class="arg"><span class="repl">&lt;...&gt;</span></span> is the location of your kernel source tree.</div>
    </div>

    <div class="indent">
        <a name="Running/debugging_this_example_on_the_Cortex-A9x1_FVP_model"></a><h2>Running/debugging this example on the Cortex-A9x1 FVP model</h2>
        <div class="para">To run this example on the Cortex-A9x1 FVP model as supplied with Development Studio:</div>
        <ol>
        <li><div class="para">First download the "Linux Distribution Example" package from <a href="https://developer.arm.com/tools-and-software/embedded/legacy-tools/ds-5-development-studio/downloads" title="External link"><i>Downloads on developer.arm.com</i></a> then either unzip it into a local folder on your hard-disk or import it into your workspace</div></li>
        <li><div class="para">On Windows, from the Start menu, open an <span class="interface">Arm DS Command Prompt</span>, then navigate to the <span class="arg">distribution</span> folder where the Linux Distribution was unzipped</div></li>
        <li><div class="para">On Linux, navigate to the <span class="arg">distribution</span> folder where the Linux Distribution was unzipped</div></li>
        <li>
<div class="para">Prepare to boot Linux on the Cortex-A9x1 FVP model with:</div>
              <div class="para"><span class="arg">FVP_VE_Cortex-A9x1 -a "boot\FVP\FVP_VE_V7\FVP_VE_V7.axf" --data "kernel\linux-linaro-3.4-rc3-2012.04-0-patched\built\VE_V7\arch\arm\boot\Image@0x80008000" --data "boot\FVP\FVP_VE_V7\rtsm_ve-cortex_a9x4.dtb@0x80f00000" -C motherboard.mmc.p_mmc_file="boot\FVP\FVP_VE_V7\linaro-image-alip-genericarmv7a-20150323-328.rootfs.tar.gz_VE_V7.image" -C cluster.cpu0.semihosting-enable=0 -C motherboard.terminal_3.start_telnet=false -C motherboard.terminal_3.mode=raw -C motherboard.pl011_uart3.untimed_fifos=true -C motherboard.terminal_3.start_port=5003 -C motherboard.smsc_91c111.enabled=1 -C motherboard.hostbridge.userNetworking=1 -C motherboard.hostbridge.userNetPorts="5555=5555,22=22,8080=8080" --iris-server</span></div>
              <div class="para">Port 5555 is used for debug, 22 for sshd, and 8080 for httpd.</div>
              <div class="para">For Linux hosts, you may need to use "8022=22" for sshd.  If so, the Remote Systems configuration must be adjusted accordingly (see below)</div>
              <div class="para">The <span class="arg">--iris-server</span> parameter tells the model to wait for a debugger to be connected.</div>
</li>
        <li><div class="para">In Development Studio, from <span class="menu">Run<span class="para"> → </span>Debug Configurations...</span>, select <span class="arg">kernel-module-FVP-VE-A9x1</span>, then click <span class="interface">Debug</span>.
        This is pre-configured to connect to the waiting Cortex-A9x1 FVP model and continue launching Linux.</div></li>
        <li><div class="para">Wait for the Linux boot to complete and for the Linux Desktop to appear in the Fast Models CLCD</div></li>
        <li>
<div class="para">In the <span class="interface">Commands</span> view, load the debug symbols for the kernel with:</div>
        <div class="para"><span class="arg">add-symbol-file distribution/kernel/linux-linaro-3.4-rc3-2012.04-0-patched/built/VE_V7/vmlinux S:0</span></div>
        <div class="para">The "S:0" means load the kernel debug symbols for secure state, because the kernel is running in secure state</div>
        <div class="para">You should see:</div>
        <pre class="code">WARNING(IMG66): Unable to check the image is the correct endianness as the target is running.
        Enabled Linux kernel support for version "Linux genericarmv7a 3.4.0-rc3-ve-v7-ds5 #1 SMP Fri Oct 21 00:18:32 BST 2016 armv7l"</pre>
</li>
        <li>
<div class="para">In the <span class="interface">Commands</span> view, load the debug symbols for the kernel module with:</div>
        <div class="para"><span class="arg">add-symbol-file kernel_module/FVP_VE_V7/modex.ko</span></div>
        <div class="para">Kernel module debug symbols loading must not carry the S:0 argument.</div>
        <div class="para">You should see:</div>
        <pre class="code">WARNING(ITR506): The operating system module kernel_module\FVP_VE_V7\modex.ko is currently not loaded so the request has been pended</pre>
        <div class="para">This is expected - the symbols will become active once the kernel module is inserted.</div>
</li>
        <li><div class="para">Leave <span class="arg">kernel-module-FVP-VE-A9x1</span> connected and running</div></li>
        <li><div class="para">Open a <span class="interface">Remote Systems</span> view by using <span class="menu">Window<span class="para"> → </span>Show View<span class="para"> → </span>Other<span class="para"> → </span>Remote Systems<span class="para"> → </span>Remote Systems</span>
</div></li>
        <li><div class="para">In the <span class="interface">Remote Systems</span> view, click on <span class="interface">Define a connection to remote system</span>.  Select <span class="interface">SSH Only</span>, then click <span class="interface">Next</span>.
        In the <span class="interface">Host name</span> field, enter "localhost" then click <span class="interface">Finish</span>
</div></li>
        <li><div class="para">If you used "8022=22" for sshd, then you must adjust the Remote Systems configuration accordingly.
        In the <span class="interface">Remote Systems</span> view, right-mouse-click on <span class="interface">Sftp Files</span>, then select <span class="interface">Properties</span>.
        Select <span class="interface">Subsystem</span>, change the port number from the default 22 to 8022, then click <span class="interface">OK</span>
</div></li>
        <li><div class="para">In the <span class="interface">Remote Systems</span> view, expand <span class="interface">Sftp Files</span>, then expand <span class="interface">Root</span>.
        In <span class="interface">Enter Password</span>, enter User ID="root", then click <span class="interface">OK</span>.  Expand <span class="interface">/home/root</span>.  The contents of the <span class="arg">/home/root</span> folder is displayed, initially empty</div></li>
        <li><div class="para">Right-mouse-click on <span class="interface">Ssh Terminals</span> and select <span class="interface">Launch Terminal</span>.  The "root@genericarmv7a" prompt appears in the <span class="interface">Terminals</span> view</div></li>
        <li><div class="para">From <span class="menu">Run<span class="para"> → </span>Debug Configurations...</span>, select <span class="arg">kernel-mainapp-FVP-VE-A9x1</span>, then click <span class="interface">Debug</span>.
        This is pre-configured to connect to Linux on the Cortex-A9x1 FVP model, download the stripped <span class="arg">main</span> application and kernel module <span class="arg">modex.ko</span> to /home/root/, start gdbserver on the target, load the debug information from the debug/unstripped version of the <span class="arg">main</span> application into the Debugger, then start executing the <span class="arg">main</span> application, stopping at <span class="arg">main()</span>
</div></li>
        </ol>
    </div>

    <div class="indent">
        <a name="Using_the_kernel_module"></a><h2>Using the kernel module</h2>
        <div class="para">Using the FVP model target's console, navigate to the directory on the target where <span class="arg">modex.ko</span> is located, then execute the following commands on the target:</div>
        <ol>
        <li>
<div class="para">Install the module:</div>
        <pre class="code">insmod modex.ko</pre>
</li>
        <li>
<div class="para">See that it has been registered as device number 42 with:</div>
        <pre class="code">grep 42 /proc/devices</pre>
</li>
        <li>
<div class="para">See that the module is active with:</div>
        <pre class="code">cat /proc/modules</pre>
</li>
        <li>
<div class="para">Verify the device node <span class="arg">/dev/modex</span> has been created with:</div>
        <pre class="code">ls -al /dev/m*</pre>
</li>
        <li>
<div class="para">Display information about all loaded modules:</div>
        <pre class="code">lsmod</pre>
</li>
        <li>
<div class="para">Read from the module with:</div>
        <pre class="code">cat /dev/modex</pre>
</li>
        <li>
<div class="para">Send the module a byte of data with, for example:</div>
        <pre class="code">echo -ne "\001" &gt; /dev/modex</pre>
        <div class="para">The module can be put into a "test mode" by sending it the character '+'.  In this test mode, the character 'A' triggers an abort, and 'P' triggers a kernel panic().  Test mode is exited by sending the module the character '-'.</div>
</li>
        <li>
<div class="para">Uninstall the module:</div>
        <pre class="code">rmmod modex</pre>
</li>
        </ol>
        <div class="para">The user-space <span class="arg">main</span> application, built from <span class="arg">main.c</span>, can be used to read/write modex, similar to steps 6 and 7 above.</div>
    </div>

    <div class="indent">
        <a name="Debugging_the_kernel_module"></a><h2>Debugging the kernel module</h2>
        <div class="para">To debug the kernel module with the Debugger, you must have imported into your workspace the "Linux Distribution Example" package that can be downloaded from the <a href="https://developer.arm.com/tools-and-software/embedded/legacy-tools/ds-5-development-studio/downloads" title="External link"><i>Downloads on developer.arm.com</i></a>.</div>
        <div class="para">First establish a debug connection from the Debugger to the target using
        <span class="menu">Run<span class="para"> → </span>Debug Configurations...</span>, then selecting the
        <span class="arg">kernel-module-FVP-VE-A9x1</span> configuration provided.  These establish a kernel module debug connection to the running Arm Linux target.</div>
        <div class="para">If connecting to real hardware then enter the USB: or TCP: IP address or name of your DSTREAM or ULINK unit in the <span class="interface">Debug Hardware Address</span> field of the <span class="interface">Connections</span> panel. Otherwise an error will be reported: <span class="arg">
        <span class="arg">Launch configuration has errors: Configuration for connection type 'Bare Metal Debug' is not valid - Connection cannot be empty</span>
</span>.</div>

        <div class="para">The debug configurations select:</div>
        <ul>
        <li><div class="para">The target Platform, Project type, and Debug Operation</div></li>
        <li><div class="para">The <span class="arg">vmlinux</span> file from which to load kernel debug symbols</div></li>
        <li><div class="para">The debug/unstripped version of <span class="arg">modex.ko</span> from which to load kernel module debug symbols</div></li>
        <li><div class="para">Connect-only (rather than "Debug from entry point" or "Debug from main").</div></li>
        </ul>

        <div class="para">For <span class="arg">kernel-module-FVP-VE-A9x1</span>, kernel debug symbols are loaded for secure state with, for example, <span class="arg">add-symbol-file vmlinux S:0</span> because the kernel is running in secure state.  Kernel module debug symbols loading must not carry the S:0 argument.</div>

        <div class="para">After establishing a debug connection, you can debug the kernel module at source level in the usual way, as illustrated in the following example session.</div>
        <ol>
            <li>
            <div class="para">In the <span class="interface">Commands</span> view, select the <span class="arg">kernel-module-FVP-VE-A9x1</span> connection.</div>
            </li>
            <li>
            <div class="para">Stop the target.  The kernel on the target will then become unresponsive.</div>
            </li>
            <li>
            <div class="para">If you see <span class="interface">Source Not Found</span> for e.g. <span class="arg">proc-v7.S</span>, you can optionally untar the kernel sources provided in <span class="arg">source.tar.bz2</span> and then use <span class="interface">Set Path Substitution</span> to set the patch to the correct source file.</div>
            </li>
            <li>
            <div class="para">In the <span class="interface">Commands</span> view, reload the debug symbols for the kernel module with:</div>
            <div class="para"><span class="arg">add-symbol-file kernel_module/FVP_VE_V7/modex.ko</span></div>
            </li>
            <li>
            <div class="para">The module initialization function <span class="arg">modex_init()</span> is called when the module is inserted.
            To trap this, set a breakpoint on this function by either typing <span class="arg">break -p modex_init</span> at the Debugger command-line,
            or opening the source file <span class="arg">modex.c</span> and double-clicking on line 115.
            As <span class="arg">modex.ko</span> has not yet been installed, and the debug symbols for it not yet loaded, the Debugger sets a "pending breakpoint".
            Restart the target by pressing F8. The kernel becomes responsive again.</div>
            </li>
            <li>
            <div class="para">If necessary, log into the target system as user <span class="arg">root</span>, with no password.</div>
            <div class="para">Insert the module by navigating on the target to the directory where the module is installed and typing:</div>
            <pre class="code">insmod modex.ko</pre>
            <div class="para">Target execution stops at the function <span class="arg">modex_init()</span>.
            You can now view variables, view memory, view disassembly, single-step, etc. in the Debugger</div>
            </li>
            <li>
            <div class="para">You can view information about the loaded module by either typing <span class="arg">info os-modules</span> at the Debugger command-line,
            or opening the Modules view with <span class="menu">Window<span class="para"> → </span>Show View<span class="para"> → </span>Modules</span>.</div>
            </li>
            <li>
            <div class="para">Set more breakpoints, on <span class="arg">modex_read()</span>, <span class="arg">modex_write()</span>, and <span class="arg">modex_exit()</span>. Restart the target by pressing F8.</div>
            </li>
            <li>
<div class="para">Read from the module with:</div>
            <pre class="code">cat /dev/modex</pre>
            <div class="para">Target execution stops at the function <span class="arg">modex_read()</span>.  Restart the target by pressing F8.</div>
            <div class="para">The kernel calls <span class="arg">modex_read()</span> twice, so target execution will stop again. Restart the target once more by pressing F8.</div>
            </li>
            <li>
<div class="para">Send the module a byte of data with, for example:</div>
            <pre class="code">echo -ne "\001" &gt; /dev/modex</pre>
            <div class="para">Target execution stops at the function <span class="arg">modex_write()</span>.  Restart the target by pressing F8.</div>
            </li>
            <li>
<div class="para">Remove the module:</div>
            <pre class="code">rmmod modex</pre>
            <div class="para">Target execution stops at the function <span class="arg">modex_exit()</span>.  Restart the target by pressing F8.</div>
            </li>
            <li>
            <div class="para">Disconnect the debug connection.</div>
            </li>
        </ol>
    </div>

    <div class="indent">
        <a name="Debugging_a_user-space_application_and_kernel_module_together"></a><h2>Debugging a user-space application and kernel module together</h2>
        <div class="para">It is also possible to debug a user-space application and kernel module together.
        The following example shows stopping an application at a breakpoint in user-space just before it makes a call into a kernel module,
        then stopping again at a breakpoint inside the kernel module, then stopping again after returning to the application.
        This requires two debug connections: a kernel/module debug connection to the kernel module; and a gdbserver debug connection to the application.
        Beware that the target processor is stopped when a kernel/module breakpoint is hit, so gdbserver will become unresponsive until the target is
        restarted.</div>
        <ol>
            <li>
            <div class="para">Ensure the stripped kernel module <span class="arg">.../kernel_module/your_platform/stripped/modex.ko</span> has been copied to the <span class="arg">/home/root</span> directory
            on the target.  The (stripped) user-space application <span class="arg">main</span> will get copied as part of the gdbserver debug connection shortly.</div>
            </li>
            <li>
            <div class="para">Establish a kernel/module debug connection to the kernel module in the same way as before using the
            <span class="arg">kernel-module-FVP-VE-A9x1</span> configuration provided.  Do not stop the target yet.</div>
            </li>
            <li>
            <div class="para">Establish a gdbserver debug connection to the application using the <span class="arg">kernel-mainapp-*</span> configuration suitable for your target.</div>
            </li>
            <li>
            <div class="para">Ensure the mainapp debug context is selected in Debug Control.  It should show "stopped".
            Set a breakpoint in <span class="arg">main.c</span> at line 39 on the call to read from modex,
            and at line 40 on the printf to display the value read from modex.</div>
            </li>
            <li>
            <div class="para">If necessary, log into the target system as user <span class="arg">root</span>, with no password.</div>
            <div class="para">Insert the module by navigating on the target to the directory where the module is installed and typing:</div>
            <pre class="code">insmod modex.ko</pre>
            <div class="para">The Debugger detects this and loads the debug symbols for <span class="arg">modex.ko</span>.</div>
            </li>
            <li>
            <div class="para">Select the module debug context in Debug Control.  It should show "running".  Stop the target.
            Set a breakpoint on the modex read function by either typing <span class="arg">break modex_read</span> at the Debugger command-line,
            or opening the source file <span class="arg">modex.c</span> and double-clicking on line 59.  Restart the target.</div>
            </li>
            <li>
            <div class="para">Select the mainapp debug context in Debug Control.  It should show "stopped".  Start the mainapp running.
            It will start running, then stop at the first breakpoint in <span class="arg">main.c</span>.
            You can now view variables, view memory, view disassembly, single-step, etc. in the application.</div>
            </li>
            <li>
            <div class="para">Restart the target.  It will start running, then stop at the breakpoint in <span class="arg">modex.c</span>.
            The module debug context in Debug Control should show "stopped".</div>
            </li>
            <li>
            <div class="para">Select the module debug context in Debug Control.  The source file <span class="arg">modex.c</span> appears in the editor.
            You may need to set the source substitution path to view this.
            You can now view variables, view memory, view disassembly, single-step, etc. in the kernel module.</div>
            </li>
            <li>
            <div class="para">Restart the target.  The kernel calls <span class="arg">modex_read()</span> twice, so it may be necessary to restart a second time, depending on whether you have done any stepping. It will start running, then stop at the second breakpoint in <span class="arg">main.c</span>.
            The mainapp debug context in Debug Control should show "stopped".</div>
            </li>
            <li>
            <div class="para">Select the mainapp debug context in Debug Control.
            You can now view variables, view memory, view disassembly, single-step, etc. in the application.</div>
            </li>
            <li>
            <div class="para">Run to the end of the application, then disconnect the two debug connections.</div>
            </li>
        </ol>
    </div>

    <div class="indent">
        <a name="Known_issues_and_troubleshooting"></a><h2>Known issues and troubleshooting</h2>
        <ul>
            
    <li>
    <div class="para">When importing the example Linux distribution example on Windows, you will see, for example:</div>
    <pre class="code">
Problems were encountered during import:
A resource exists with a different case: /distribution/filesystem/linaro_hf/usr/include/linux/netfilter_ipv6/ip6t_HL.h</pre>
    <div class="para">This is expected behaviour when unpacking the Linux kernel on Windows.  The Linux kernel sources are intended to be unpacked, used and built on a Linux platform, not on Windows.
    This problem is caused by Windows not being able to differentiate between upper and lower case in filenames (e.g. foo.h versus foo.H), where Linux treats these as separate files.</div>
    </li>

            <li>
            <div class="para">The Linux target reports: <span class="arg"># Cannot exec ./main: Permission denied.</span>
</div>
            <div class="para">if you have not set execute permissions on the user-space application.  Use, for example, <span class="arg">chmod +x main</span>.</div>
            </li>
            <li>
            <div class="para">The Linux target reports: <span class="arg">insmod: can't insert 'modex.ko': invalid module format</span>
</div>
            <div class="para">if there is a mis-match between the version of the kernel that <span class="arg">modex.ko</span> was built against and the kernel currently running on your target.  Try rebuilding <span class="arg">modex.ko</span> against the correct version of the kernel and/or change the kernel on the target to the one you've just built your module against.</div>
            </li>
            <li>
            <div class="para">Breakpoints are not being hit in the kernel module:</div>
            <div class="para">Ensure the kernel module on your target matches the one on the host.
            The code/data layout must be identical, though the kernel module on your target does not need to contain debug symbols, i.e. these can be stripped to reduce image size.
            Try copying the kernel module across from host to target again.</div>
            </li>
            <li>
            <div class="para">The Example kernel module <span class="arg">modex.ko</span> is only accessible by user applications running as root, not by any other user.
            This is because udev defaults to 660 access permissions.  An attempt to use <span class="arg">modex.ko</span> from non-root users will report:
            <span class="arg">Failed to open /dev/modex</span>.</div>
            <div class="para">A temporary workaround is for root to set: <span class="arg">chmod o+w /dev/modex</span>
</div>
            <div class="para">The correct solution is for root to add the file: <span class="arg">/etc/udev/rules.d/99-modex.rules</span> containing:
            <span class="arg">KERNEL=="modex", MODE="0666"</span>
</div>
            </li>
            <li>
            <div class="para">
<span class="arg">Syntax error</span> is reported in the <span class="interface">Editor</span> view for <span class="arg">printk()</span> and other source keywords commonly used in kernel modules :</div>
            <div class="para">For example, <span class="arg">__init</span>, <span class="arg">__exit</span>, <span class="arg">module_init()</span> and <span class="arg">module_exit()</span> are defined as macros in <span class="arg">&lt;linux/init.h&gt;</span>. 
            The kernel Makefile defines <span class="arg">__KERNEL__</span>, which is needed to activate these macros, but the Indexer does not import Makefile defines.  
            This is worked-around in the supplied project by adding <span class="arg">__KERNEL__</span> to the list of project's symbols via Project -&gt; Properties -&gt; C/C++ General -&gt; Paths and Symbols -&gt; Symbols.</div>
            <div class="para">Furthermore, <span class="arg">printk()</span> is defined in <span class="arg">&lt;linux/kernel.h&gt;</span>, but Eclipse must be given the path to it by adding the kernel include directory (for example, <span class="arg">.../distribution/kernel/linux-linaro-3.4-rc3-2012.04-0-patched/source/include</span>) as a Workspace path to the project's Paths and Symbols 'GNU C' includes.
            The kernel sources in <span class="arg">source.tar.bz2</span> must be manually untar'd on Windows for this workaround to become visible.  You can use this same workaround in your own Eclipse projects for kernel modules.</div>
            </li>
            <li>
            <div class="para">The Debugger reports in its <span class="interface">Commands</span> view:</div>
            <pre class="code">ERROR(CMD685-CMD19):
! Failed to load symbols for "vmlinux"
! Image ".../built/V7/vmlinux" does not exist</pre>
            <div class="para">The kernel debug symbols are missing. To debug this example, you must have imported into your workspace the "Linux Distribution Example" package that can be downloaded from the <a href="https://developer.arm.com/tools-and-software/embedded/legacy-tools/ds-5-development-studio/downloads" title="External link"><i>Downloads on developer.arm.com</i></a>.</div>
            </li>
            <li>
            <div class="para">The Debugger reports in its <span class="interface">Commands</span> view:
            <span class="arg">ERROR(LKN35): Unable to read target kernel version. This might be caused by a mismatch between kernel symbols and the kernel on the target or Linux is not running on the target.</span>
</div>
            <div class="para">The kernel debug symbols do not match the kernel on the target. You should be using the kernel debug symbols from the "Linux Distribution Example" package that can be downloaded from the <a href="https://developer.arm.com/tools-and-software/embedded/legacy-tools/ds-5-development-studio/downloads" title="External link"><i>Downloads on developer.arm.com</i></a> and a Linux distribution from one of the packages located alongside it. Rebuilding the kernels in these packages is sufficient to cause this message to appear.</div>
            </li>
            <li>
            <div class="para">The Debugger reports in its <span class="interface">Commands</span> view:</div>
            <pre class="code">ERROR(CMD16-LKN38):
! Failed to load symbols for "modex.ko"
! Operating system support is not active.</pre>
            <div class="para">If this appears in conjunction with <span class="arg">ERROR(LKN35)</span> then see above entry for that error. Otherwise, ensure that Linux is running on the target.</div>
            </li>
            <li>
            <div class="para">Module fails to build with errors as follows:</div>
            <pre class="code">scripts/selinux/genheaders/genheaders.c:13:22: error: classmap.h: No such file or directory
scripts/selinux/genheaders/genheaders.c:14:35: error: initial_sid_to_string.h: No such file or directory
scripts/selinux/genheaders/genheaders.c: In function 'main'
scripts/selinux/genheaders/genheaders.c:61: error: 'secclass_map' undeclared (first use in this function)
scripts/selinux/genheaders/genheaders.c:61: error: (Each undeclared identifier is reported only once
scripts/selinux/genheaders/genheaders.c:61: error: for each function it appears in.)
scripts/selinux/genheaders/genheaders.c:68: error: 'initial_sid_to_string' undeclared (first use in this function)
make[4]: *** [scripts/selinux/genheaders/genheaders] Error 1
make[3]: *** [scripts/selinux/genheaders] Error 2
make[2]: *** [scripts/selinux] Error 2
make[1]: *** [scripts] Error 2
make: *** [all] Error 2</pre>
            <div class="para">You can avoid this by not building the selinux build scripts. In the kernel source tree, open file <span class="arg">scripts/Makefile</span> and remove line <span class="arg">subdir-$(CONFIG_SECURITY_SELINUX) += selinux</span>.</div>
            </li>

            
    <li>
<div class="para">On Windows 7 and later, launching a debug configuration to connect to a Fixed Virtual Platform (FVP) model may give the following error: <span class="arg">Windows cannot find "C:\Windows\System32\telnet.exe"</span> or <span class="arg">No telnet executable was found on your system</span>.  Arm FVP models make use of "telnet" as a serial terminal, to enable serial data to be transferred from application code running on an Arm FVP via a modelled UART to a serial terminal.  This error occurs when the telnet client is disabled or otherwise unavailable on your computer.  The telnet client is not enabled by default on Windows 7 and later.  To enable the telnet client on Windows 10:</div>
        <ol>
            <li><div class="para">Right-click on the Start menu, then select "Settings"</div></li>
            <li><div class="para">Search for "Telnet", and select "Turn Windows features on or off"</div></li>
            <li><div class="para">From the list that appears, tick the "Telnet Client" checkbox</div></li>
            <li><div class="para">Click "OK" to close the dialog.</div></li>
        </ol>
    </li>


        </ul>
    </div>

    <h2>See also:</h2>
<div class="indent"><ul>
        <li><div class="para"><a href="https://developer.arm.com/documentation/101469/latest/Debugging-code/Overview--Debug-connections-in-Arm-Debugger"><i>Debug connections in Arm Debugger</i> in <i>Arm Development Studio Getting Started Guide</i></a></div></li>
        <li><div class="para"><a href="https://developer.arm.com/documentation/101470/latest/"><i>Arm Development Studio User Guide</i></a></div></li>
        <li><div class="para"><a href="https://developer.arm.com/documentation/101471/latest/"><i>Arm Debugger Command Reference</i></a></div></li>
        <li><div class="para"><a href="https://developer.arm.com/documentation/100966/latest/"><i>Fixed Virtual Platforms FVP Reference Guide</i></a></div></li>
        <li><div class="para"><a href="https://developer.arm.com/documentation/100955/latest"><i>DSTREAM User Guide</i></a></div></li>
    </ul></div>
</div>
<div class="double_dotted_divider"></div>
<div class="footer">Copyright© 2010-2022 Arm Limited (or its affiliates). All rights reserved.</div>
</body>
</html>
